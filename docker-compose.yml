services:
  openclaw:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-secure
    command: ["node", "openclaw.mjs", "gateway", "--allow-unconfigured"]
    entrypoint: ["/usr/local/bin/entrypoint-with-secrets.sh"]

    ports:
      - "127.0.0.1:${OPENCLAW_PORT:-3010}:3010"

    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
      - /run:rw,noexec,nosuid,size=16m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    pids_limit: 256
    mem_limit: 8g
    restart: unless-stopped

    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 12s
      retries: 3
      start_period: 45s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    volumes:
      - type: bind
        source: ./config
        target: /opt/openclaw/config
        read_only: true
      - type: bind
        source: ./scripts/entrypoint-with-secrets.sh
        target: /usr/local/bin/entrypoint-with-secrets.sh
        read_only: true
      - type: bind
        source: ./scripts/healthcheck.sh
        target: /usr/local/bin/healthcheck.sh
        read_only: true
      - type: bind
        source: ${HOME}/.codex/auth.json
        target: /home/node/.codex/auth.json
        read_only: true
      - type: bind
        source: ./workspace
        target: /home/node/.openclaw
        read_only: false

    secrets:
      - discord_bot_token
      - openclaw_gateway_token
      - discord_guild_id
      - discord_channel_ids
      - discord_user_ids

    environment:
      CLAW_AGENT_PROVIDER: openai-codex
      DISCORD_BOT_TOKEN_FILE: /run/secrets/discord_bot_token
      OPENCLAW_GATEWAY_TOKEN_FILE: /run/secrets/openclaw_gateway_token
      OPENCLAW_DISCORD_GUILD_ID_FILE: /run/secrets/discord_guild_id
      OPENCLAW_DISCORD_CHANNEL_IDS_FILE: /run/secrets/discord_channel_ids
      OPENCLAW_DISCORD_USER_IDS_FILE: /run/secrets/discord_user_ids
      OPENCLAW_CONFIG_PATH: /opt/openclaw/config/openclaw.json
      OPENCLAW_MODEL_PRIMARY: openai-codex/gpt-5.3-codex
      OPENCLAW_FS_WORKSPACE_ONLY: "true"
      OPENCLAW_EXEC_SECURITY: "allowlist"
      OPENCLAW_EXEC_ASK: "off"
      OPENCLAW_EXEC_SAFE_BINS: ls,cat,rg,sed,awk,head,tail,wc,git
      OPENCLAW_MENTION_PATTERN: \b@?claw\b
      OPENCLAW_REQUIRE_MENTION: "true"
      NODE_OPTIONS: --max-old-space-size=2048

secrets:
  discord_bot_token:
    file: ./secrets/discord_bot_token.txt
  openclaw_gateway_token:
    file: ./secrets/gateway_token.txt
  discord_guild_id:
    file: ./secrets/discord_guild_id.txt
  discord_channel_ids:
    file: ./secrets/discord_channel_ids.txt
  discord_user_ids:
    file: ./secrets/discord_user_ids.txt
